import random
from sklearn import svm
from collections import defaultdict
from unittest import TestCase

from src.data.brain_regions import REGIONS

from tests import get_testing_neuron_db

from src.utils.formatting import percentage
from tests import log_dev_url_for_root_ids


class OlTaggingTest(TestCase):
    @classmethod
    def setUpClass(cls):
        cls.neuron_db = get_testing_neuron_db()

    def test_optic_lobe_labels(self):
        ol_rids = self.neuron_db.search("super_class == optic")
        self.assertGreater(len(ol_rids), 73000)
        unlabeled_ol_cell_ids_with_similar_scores = defaultdict(set)

        def report(rid1, rid2):
            if self.neuron_db.neuron_data[rid1]["label"]:
                if not self.neuron_db.neuron_data[rid2]["label"]:
                    unlabeled_ol_cell_ids_with_similar_scores[rid2].add(rid1)
            elif self.neuron_db.neuron_data[rid2]["label"]:
                unlabeled_ol_cell_ids_with_similar_scores[rid1].add(rid2)

        for r in ol_rids:
            for sid, score in self.neuron_db.neuron_data[r][
                "similar_cell_scores"
            ].items():
                if score >= 6:
                    report(r, sid)

        for k, v in unlabeled_ol_cell_ids_with_similar_scores.items():
            print(f"{k} {v}")

        self.assertGreater(len(unlabeled_ol_cell_ids_with_similar_scores), 73000)

    def test_mi1_patterns(self):
        ol_type = "mi1"
        analyze_mi1s = False
        if analyze_mi1s:
            mi1_right = [
                720575940631093608,
                720575940638779994,
                720575940640674293,
                720575940622208253,
                720575940625995568,
                720575940622025505,
                720575940609743736,
                720575940633245092,
                720575940617381533,
                720575940632263016,
                720575940646237550,
                720575940630033980,
                720575940619834644,
                720575940609887971,
                720575940643576520,
                720575940627060951,
                720575940636195320,
                720575940629975195,
                720575940646996515,
                720575940623793993,
                720575940621975254,
                720575940624769771,
                720575940616677332,
                720575940614084015,
                720575940627894600,
                720575940628994603,
                720575940625805329,
                720575940652026358,
                720575940615506399,
                720575940631492603,
                720575940640180339,
                720575940620211627,
                720575940618489758,
                720575940622609251,
                720575940631085532,
                720575940613847983,
                720575940620561835,
                720575940617946395,
                720575940622034390,
                720575940637399262,
                720575940629208684,
                720575940630934329,
                720575940622005620,
                720575940625802883,
                720575940623893223,
                720575940604427552,
                720575940625320462,
                720575940633670039,
                720575940608677845,
                720575940627594005,
                720575940639223203,
                720575940616485900,
                720575940623344969,
                720575940626584522,
                720575940626028540,
                720575940629519515,
                720575940626742921,
                720575940637933656,
                720575940629067205,
                720575940644858916,
                720575940604631520,
                720575940613903477,
                720575940624812808,
                720575940627045122,
                720575940635070063,
                720575940628997163,
                720575940628210856,
                720575940617313236,
                720575940613152493,
                720575940623800573,
                720575940628179589,
                720575940624100842,
                720575940614606742,
                720575940638559209,
                720575940605687729,
                720575940621959152,
                720575940619583902,
                720575940638114630,
                720575940635750512,
                720575940635916139,
                720575940622896861,
                720575940636572016,
                720575940647731332,
                720575940621602013,
                720575940630777206,
                720575940614953362,
                720575940634743136,
                720575940630275840,
                720575940626580938,
                720575940611680718,
                720575940612953750,
                720575940617033556,
                720575940613874738,
                720575940632959583,
                720575940621956479,
                720575940615324822,
                720575940624738997,
                720575940614847911,
                720575940649234041,
                720575940632147215,
                720575940635215770,
                720575940621196532,
                720575940615203259,
                720575940620262527,
                720575940627695749,
                720575940617426333,
                720575940632172492,
                720575940644851912,
                720575940620649893,
                720575940619258176,
                720575940625674698,
                720575940611361941,
                720575940630584796,
                720575940629289271,
                720575940631425554,
                720575940611858274,
                720575940626231068,
                720575940632367427,
                720575940620735067,
                720575940608555356,
                720575940629635884,
                720575940641935861,
                720575940627900913,
                720575940630307468,
                720575940612868067,
                720575940612007061,
                720575940616262651,
                720575940644599240,
                720575940638789454,
                720575940615991362,
                720575940626710053,
                720575940610337234,
                720575940626180892,
                720575940627979913,
                720575940627582972,
                720575940639399075,
                720575940637019255,
                720575940623414541,
                720575940640037966,
                720575940634522719,
                720575940635507055,
                720575940637889139,
                720575940638571583,
                720575940621444869,
                720575940615358119,
                720575940608228107,
                720575940613984935,
                720575940613796246,
                720575940605092700,
                720575940637562458,
                720575940612506482,
                720575940624432316,
                720575940606009534,
                720575940624608841,
                720575940624317468,
                720575940634844060,
                720575940622544297,
                720575940622823914,
                720575940635869303,
                720575940623872807,
                720575940639009087,
                720575940635080811,
                720575940627855366,
                720575940617717649,
                720575940625807972,
                720575940634999647,
                720575940652859894,
                720575940611344226,
                720575940634424601,
                720575940614810335,
                720575940628351187,
                720575940616457867,
                720575940607447241,
                720575940617927291,
                720575940624103148,
                720575940605017312,
                720575940626903634,
                720575940629972379,
                720575940609868949,
                720575940612861182,
                720575940605243424,
                720575940612028645,
                720575940622383624,
                720575940620847996,
                720575940638703669,
                720575940628562075,
                720575940616713778,
                720575940621150817,
                720575940620996289,
                720575940644074144,
                720575940612391907,
                720575940625468455,
                720575940629591543,
                720575940619288929,
                720575940619657711,
                720575940613398386,
                720575940631861775,
                720575940613634070,
                720575940620971173,
                720575940618519163,
                720575940638111285,
                720575940626680914,
                720575940615104907,
                720575940622694476,
                720575940627323279,
                720575940623457031,
                720575940622899241,
                720575940606373809,
                720575940625756676,
                720575940637219726,
                720575940610788420,
                720575940630144620,
                720575940621992662,
                720575940605441638,
                720575940624089480,
                720575940647381556,
                720575940626571909,
                720575940631132714,
                720575940617482385,
                720575940629857783,
                720575940627360168,
                720575940631032651,
                720575940605300256,
                720575940624995303,
                720575940620146256,
                720575940608497756,
                720575940626059944,
                720575940620800020,
                720575940630595525,
                720575940634116960,
                720575940628339528,
                720575940618052097,
                720575940626711242,
                720575940630967097,
                720575940617995860,
                720575940646915875,
                720575940617773405,
                720575940615588831,
                720575940619521729,
                720575940628195431,
                720575940627864326,
                720575940619635614,
                720575940628471292,
                720575940621897648,
                720575940609374818,
                720575940626070123,
                720575940612031694,
                720575940625720080,
                720575940626801445,
                720575940625249072,
                720575940630419852,
                720575940622245033,
                720575940644874020,
                720575940615376070,
                720575940613721837,
                720575940631330255,
                720575940630130391,
                720575940623048662,
                720575940633780505,
                720575940621636534,
                720575940630347898,
                720575940623263501,
                720575940625087434,
                720575940626328535,
                720575940621612897,
                720575940622859305,
                720575940611944434,
                720575940619605639,
                720575940622089605,
                720575940629047851,
                720575940626292376,
                720575940626897930,
                720575940618916699,
                720575940615049046,
                720575940628657670,
                720575940612984722,
                720575940629645927,
                720575940633989472,
                720575940614856359,
                720575940626941700,
                720575940615462550,
                720575940652044790,
                720575940621539494,
                720575940630704184,
                720575940628462700,
                720575940612506354,
                720575940615032799,
                720575940645823028,
                720575940628293648,
                720575940632628947,
                720575940639510616,
                720575940620413606,
                720575940622636713,
                720575940637468016,
                720575940625954579,
                720575940610106414,
                720575940636230286,
                720575940617590587,
                720575940610316242,
                720575940620716123,
                720575940608810947,
                720575940615140767,
                720575940606863026,
                720575940624609353,
                720575940613006614,
                720575940615466562,
                720575940638256693,
                720575940626495518,
                720575940618302262,
                720575940632016143,
                720575940617297803,
                720575940622113012,
                720575940636193784,
                720575940622912041,
                720575940629330882,
                720575940650277497,
                720575940618111296,
                720575940618045414,
                720575940621056109,
                720575940630349111,
                720575940622424325,
                720575940621499841,
                720575940631189445,
                720575940623873063,
                720575940621496559,
                720575940616559558,
                720575940621550830,
                720575940632226371,
                720575940625572851,
                720575940624550069,
                720575940631639656,
                720575940622129927,
                720575940627484657,
                720575940627105354,
                720575940612659826,
                720575940631885476,
                720575940614269182,
                720575940637206640,
                720575940621337792,
                720575940621643041,
                720575940620253872,
                720575940654696097,
                720575940617033309,
                720575940623296525,
                720575940617356066,
                720575940628095560,
                720575940619735941,
                720575940624001288,
                720575940620543297,
                720575940639592381,
                720575940618887515,
                720575940610502862,
                720575940628618664,
                720575940637643748,
                720575940624900844,
                720575940626373784,
                720575940630282496,
                720575940625770254,
                720575940631966511,
                720575940618670875,
                720575940619249019,
                720575940610057434,
                720575940643223319,
                720575940622532036,
                720575940614268050,
                720575940631077903,
                720575940612966546,
                720575940623478154,
                720575940627306907,
                720575940619321991,
                720575940623475463,
                720575940630763940,
                720575940608921097,
                720575940628481276,
                720575940642297997,
                720575940620226849,
                720575940614997772,
                720575940615729567,
                720575940617982021,
                720575940631243331,
                720575940618461723,
                720575940638397929,
                720575940612977066,
                720575940608390869,
                720575940625561993,
                720575940614429992,
                720575940642102669,
                720575940620088941,
                720575940620157611,
                720575940619205286,
                720575940620807851,
                720575940638763061,
                720575940633918968,
                720575940617563419,
                720575940625113579,
                720575940626978874,
                720575940626412688,
                720575940638279999,
                720575940639594624,
                720575940616072821,
                720575940611865829,
                720575940626230986,
                720575940631249325,
                720575940631238968,
                720575940619554224,
                720575940624434685,
                720575940617675705,
                720575940607157801,
                720575940612181221,
                720575940627861233,
                720575940620014445,
                720575940620809894,
                720575940609890787,
                720575940630002908,
                720575940620026816,
                720575940617633088,
                720575940618492283,
                720575940612382634,
                720575940612098766,
                720575940641611739,
                720575940626128016,
                720575940624451260,
                720575940621582156,
                720575940613079932,
                720575940617469657,
                720575940624009107,
                720575940621784979,
                720575940630933241,
                720575940617355521,
                720575940623072844,
                720575940629006065,
                720575940617972549,
                720575940626881082,
                720575940620721856,
                720575940614281523,
                720575940619660112,
                720575940634447516,
                720575940640017717,
                720575940614915582,
                720575940632772655,
                720575940645488692,
                720575940628134647,
                720575940627661370,
                720575940630787788,
                720575940607253744,
                720575940636525687,
                720575940628390543,
                720575940633222113,
                720575940620120454,
                720575940621777268,
                720575940615517746,
                720575940617537209,
                720575940630276412,
                720575940637031536,
                720575940617992121,
                720575940622545961,
                720575940627035153,
                720575940612210289,
                720575940629959900,
                720575940621216752,
                720575940631868946,
                720575940616492230,
                720575940632285068,
                720575940639363133,
                720575940627346856,
                720575940631413753,
                720575940618530206,
                720575940659700609,
                720575940622468888,
                720575940622333365,
                720575940622583646,
                720575940613978065,
                720575940615452305,
                720575940632281912,
                720575940639240253,
                720575940632333260,
                720575940620344097,
                720575940626776597,
                720575940628573994,
                720575940613985959,
                720575940629993466,
                720575940623798003,
                720575940623801063,
                720575940635178744,
                720575940610902806,
                720575940630263234,
                720575940628959431,
                720575940627469903,
                720575940625487882,
                720575940616543813,
                720575940637305054,
                720575940618959622,
                720575940611642773,
                720575940631173975,
                720575940632766399,
                720575940605354668,
                720575940628618755,
                720575940621376244,
                720575940647959172,
                720575940632288298,
                720575940610665898,
                720575940622628232,
                720575940627469642,
                720575940632089362,
                720575940623148045,
                720575940629685291,
                720575940625442574,
                720575940634610807,
                720575940632955532,
                720575940626031381,
                720575940617455163,
                720575940632111052,
                720575940629800347,
                720575940631203757,
                720575940621364907,
                720575940626209317,
                720575940616375995,
                720575940644398190,
                720575940614109438,
                720575940623120618,
                720575940622870860,
                720575940629131249,
                720575940639318872,
                720575940621318271,
                720575940629786779,
                720575940611028594,
                720575940624376039,
                720575940623818277,
                720575940618641531,
                720575940629721130,
                720575940627779205,
                720575940608275696,
                720575940613081041,
                720575940639497781,
                720575940634028655,
                720575940621894988,
                720575940621749793,
                720575940624568846,
                720575940623122175,
                720575940610174387,
                720575940650356857,
                720575940620872630,
                720575940631093352,
                720575940628104762,
                720575940626639106,
                720575940639496245,
                720575940631297583,
                720575940624181396,
                720575940614455277,
                720575940634769509,
                720575940614427253,
                720575940644213028,
                720575940618172500,
                720575940613759795,
                720575940629745975,
                720575940623723814,
                720575940622516504,
                720575940623349203,
                720575940632382767,
                720575940614966481,
                720575940632506579,
                720575940619896734,
                720575940622249129,
                720575940628202796,
                720575940625306160,
                720575940631693928,
                720575940625171955,
                720575940627878165,
                720575940639068288,
                720575940618504395,
                720575940645271588,
                720575940626322647,
                720575940637192805,
                720575940616071541,
                720575940615664345,
                720575940645761902,
                720575940626134319,
                720575940622307731,
                720575940638694197,
                720575940622178175,
                720575940638823477,
                720575940619737222,
                720575940622710298,
                720575940623670763,
                720575940653161633,
                720575940640332533,
                720575940609941624,
                720575940622620138,
                720575940644533527,
                720575940640156504,
                720575940631721017,
                720575940610277017,
                720575940613627567,
                720575940625807888,
                720575940610865506,
                720575940609061077,
                720575940630818322,
                720575940633570656,
                720575940630036162,
                720575940619697323,
                720575940607368322,
                720575940636985230,
                720575940628469224,
                720575940614222590,
                720575940638896216,
                720575940626768650,
                720575940622909734,
                720575940627357289,
                720575940620919028,
                720575940626053520,
                720575940651997686,
                720575940626310568,
                720575940629676367,
                720575940644322760,
                720575940624092348,
                720575940628191228,
                720575940611894509,
                720575940639373245,
                720575940634710379,
                720575940633337645,
                720575940628167848,
                720575940624438567,
                720575940630317182,
                720575940625015015,
                720575940608394709,
                720575940613097330,
                720575940617942201,
                720575940621499329,
                720575940605961830,
                720575940625018860,
                720575940621123055,
                720575940627135643,
                720575940637056398,
                720575940622030093,
                720575940615643835,
                720575940611437846,
                720575940618416517,
                720575940639258301,
                720575940633173933,
                720575940606382793,
                720575940625198887,
                720575940615631154,
                720575940654415521,
                720575940630318956,
                720575940618422254,
                720575940626259504,
                720575940625695162,
                720575940621059422,
                720575940624230839,
                720575940634585113,
                720575940633668252,
                720575940611108721,
                720575940640299392,
                720575940621952636,
                720575940622105880,
                720575940623561485,
                720575940617128331,
                720575940627892050,
                720575940641000400,
                720575940623456024,
                720575940609276171,
                720575940649409401,
                720575940604470188,
                720575940629671696,
                720575940617783355,
                720575940629829175,
                720575940660447105,
                720575940631059451,
                720575940636735088,
                720575940627433201,
                720575940629856025,
                720575940626297406,
                720575940632391264,
                720575940609038660,
                720575940612779690,
                720575940625216404,
                720575940629187587,
                720575940622457588,
                720575940614735250,
                720575940630780357,
                720575940611625877,
                720575940625630014,
                720575940623939145,
                720575940619171894,
                720575940628010395,
                720575940644873160,
                720575940633803415,
                720575940618616916,
                720575940618769969,
                720575940610580434,
                720575940618046587,
                720575940627630674,
                720575940610708292,
                720575940628534790,
                720575940621773921,
                720575940605288480,
                720575940638692405,
                720575940617719350,
                720575940609841635,
                720575940613630631,
                720575940615471884,
                720575940633328991,
                720575940618361910,
                720575940612822422,
                720575940632273706,
                720575940624984368,
                720575940622899436,
                720575940637413006,
                720575940623798013,
                720575940606700674,
                720575940632958163,
                720575940619239734,
                720575940624595179,
                720575940608212828,
                720575940632568716,
                720575940620044481,
                720575940617780283,
                720575940618559681,
                720575940617980957,
                720575940620519444,
                720575940623441171,
                720575940620456801,
                720575940623464375,
                720575940626298512,
                720575940629221199,
                720575940646661428,
                720575940636637807,
                720575940635716703,
                720575940621842183,
                720575940612235237,
                720575940607753769,
                720575940611636629,
                720575940624745655,
                720575940638675253,
                720575940628620712,
                720575940626008445,
                720575940627725072,
                720575940610315749,
                720575940621356097,
                720575940641947336,
                720575940628909434,
                720575940640521357,
                720575940639897203,
                720575940639728573,
                720575940629093246,
                720575940615133115,
                720575940627323153,
                720575940618856710,
                720575940637557567,
                720575940617526868,
                720575940636258623,
                720575940623798259,
                720575940620698192,
                720575940630921035,
                720575940618969152,
                720575940632161491,
                720575940615616874,
                720575940622588808,
                720575940627915819,
                720575940624077240,
                720575940620254640,
                720575940621307380,
                720575940619484240,
                720575940622211881,
                720575940605042656,
                720575940624198437,
                720575940616896822,
                720575940636567408,
                720575940628621815,
                720575940630597058,
                720575940621761449,
                720575940625888295,
                720575940604728009,
                720575940631942418,
                720575940639260230,
                720575940614254130,
                720575940613622946,
                720575940629488400,
                720575940647992708,
                720575940616394939,
                720575940628350407,
                720575940623191434,
                720575940619275643,
                720575940617211724,
                720575940630035215,
                720575940624901524,
                720575940625341932,
                720575940640179315,
                720575940627804286,
                720575940628537964,
                720575940629134842,
                720575940622144383,
                720575940609234185,
                720575940622209868,
                720575940614356461,
            ]
            mi1_left = [
                720575940634724453,
                720575940627009598,
                720575940612410481,
                720575940618710813,
                720575940621158925,
                720575940611778290,
                720575940623530032,
                720575940634978222,
                720575940635333227,
                720575940636028261,
                720575940621295456,
                720575940632107033,
                720575940622490381,
                720575940626064456,
                720575940619121713,
                720575940610316664,
                720575940652626934,
                720575940627882490,
                720575940638990911,
                720575940606398240,
                720575940626917635,
                720575940636275124,
                720575940633711540,
                720575940627900553,
                720575940613857251,
                720575940614826463,
                720575940629387051,
                720575940621526655,
                720575940618902811,
                720575940630475095,
                720575940630845348,
                720575940637228341,
                720575940630505297,
                720575940611667154,
                720575940610580578,
                720575940631102509,
                720575940631379512,
                720575940604151008,
                720575940611551857,
                720575940618156702,
                720575940627167253,
                720575940628439356,
                720575940623666320,
                720575940629763663,
                720575940631440697,
                720575940614047500,
                720575940615658713,
                720575940637177054,
                720575940611751347,
                720575940617213557,
                720575940626666312,
                720575940621528703,
                720575940624374013,
                720575940638827984,
                720575940609555406,
                720575940629090048,
                720575940625577912,
                720575940624402761,
                720575940624940675,
                720575940637746493,
                720575940608431061,
                720575940619997121,
                720575940629277289,
                720575940606333385,
                720575940621207053,
                720575940620343000,
                720575940608157635,
                720575940627189622,
                720575940626298364,
                720575940627053329,
                720575940608553155,
                720575940613563363,
                720575940619619510,
                720575940611838577,
                720575940623627460,
                720575940614503285,
                720575940620415568,
                720575940612031694,
                720575940618491038,
                720575940635225495,
                720575940604255712,
                720575940630123520,
                720575940621852042,
                720575940624769771,
                720575940634682487,
                720575940610460402,
                720575940622218933,
                720575940638341353,
                720575940610952198,
                720575940608211780,
                720575940632977572,
                720575940632700256,
                720575940634728043,
                720575940620519444,
                720575940627764350,
                720575940644342688,
                720575940631147484,
                720575940628437776,
                720575940631083215,
                720575940613700305,
                720575940641105883,
                720575940633345375,
                720575940648557689,
                720575940618389054,
                720575940643572334,
                720575940637161013,
                720575940633872865,
                720575940611686513,
                720575940651887094,
                720575940637977149,
                720575940629040714,
                720575940632243769,
                720575940634024303,
                720575940639546933,
                720575940624335399,
                720575940628432657,
                720575940616558405,
                720575940622447344,
                720575940627116318,
                720575940626651850,
                720575940612727550,
                720575940630407751,
                720575940621321608,
                720575940611884773,
                720575940626222681,
                720575940626298567,
                720575940612393000,
                720575940619471440,
                720575940620394712,
                720575940610925778,
                720575940618420278,
                720575940646028142,
                720575940622838408,
                720575940624234644,
                720575940630050920,
                720575940622211241,
                720575940611198321,
                720575940633076691,
                720575940614650163,
                720575940633027539,
                720575940629170220,
                720575940618295993,
                720575940632766399,
                720575940620859574,
                720575940639421016,
                720575940630142265,
                720575940650482041,
                720575940625964633,
                720575940631432901,
                720575940629678124,
                720575940620857776,
                720575940620183066,
                720575940613073918,
                720575940613921331,
                720575940610739882,
                720575940620101870,
                720575940630588101,
                720575940608309771,
                720575940627539653,
                720575940634260631,
                720575940629180422,
                720575940637651034,
                720575940617264245,
                720575940616095259,
                720575940636304218,
                720575940604947657,
                720575940614750870,
                720575940628877161,
                720575940633878684,
                720575940630919763,
                720575940605029856,
                720575940631593297,
                720575940625817768,
                720575940618795099,
                720575940636847167,
                720575940620031403,
                720575940617992121,
                720575940621959185,
                720575940613919135,
                720575940607787138,
                720575940628683516,
                720575940640503640,
                720575940616572992,
                720575940633731832,
                720575940623715837,
                720575940624217528,
                720575940625276958,
                720575940625813054,
                720575940621308912,
                720575940611524835,
                720575940655611553,
                720575940623877828,
                720575940613676975,
                720575940621189358,
                720575940622954189,
                720575940615836450,
                720575940631539397,
                720575940632155922,
                720575940627763582,
                720575940614282134,
                720575940623942408,
                720575940622977791,
                720575940624161171,
                720575940610418296,
                720575940621447350,
                720575940625483322,
                720575940630745036,
                720575940636552559,
                720575940636988813,
                720575940616496102,
                720575940640390541,
                720575940619846420,
                720575940628892432,
                720575940612162227,
                720575940621252451,
                720575940621269696,
                720575940625840146,
                720575940623820523,
                720575940632113439,
                720575940624292158,
                720575940630964551,
                720575940617037969,
                720575940620605776,
                720575940620086533,
                720575940615088034,
                720575940626774026,
                720575940618358838,
                720575940629377551,
                720575940622286669,
                720575940621902674,
                720575940619265140,
                720575940635326106,
                720575940620916389,
                720575940641151284,
                720575940630012923,
                720575940632856289,
                720575940621278221,
                720575940643633352,
                720575940622743390,
                720575940624549619,
                720575940627344783,
                720575940625448394,
                720575940610772174,
                720575940621491226,
                720575940606721801,
                720575940630962654,
                720575940627611517,
                720575940617027257,
                720575940635689626,
                720575940611489746,
                720575940621659046,
                720575940638169688,
                720575940619462070,
                720575940624467644,
                720575940610533582,
                720575940631544082,
                720575940618364325,
                720575940610438898,
                720575940614448059,
                720575940606476478,
                720575940624785934,
                720575940614607912,
                720575940634766699,
                720575940640318552,
                720575940636697670,
                720575940626449926,
                720575940628576335,
                720575940630201206,
                720575940617839832,
                720575940620500801,
                720575940612855219,
                720575940628196908,
                720575940621096686,
                720575940611780450,
                720575940622206442,
                720575940626971560,
                720575940606969289,
                720575940624121322,
                720575940636151032,
                720575940620139781,
                720575940625153836,
                720575940623160614,
                720575940627273274,
                720575940628107881,
                720575940628481276,
                720575940624177900,
                720575940604714929,
                720575940621337025,
                720575940633138330,
                720575940637238373,
                720575940631726440,
                720575940629714999,
                720575940624624432,
                720575940632845463,
                720575940625474106,
                720575940626175619,
                720575940630726674,
                720575940646215022,
                720575940628620712,
                720575940646369588,
                720575940631016275,
                720575940614570705,
                720575940637201461,
                720575940617029009,
                720575940632443804,
                720575940630508495,
                720575940660975745,
                720575940613638290,
                720575940632807359,
                720575940626812222,
                720575940616787061,
                720575940627176566,
                720575940622208253,
                720575940632460077,
                720575940622697992,
                720575940625800209,
                720575940621658790,
                720575940633839796,
                720575940626419248,
                720575940655096481,
                720575940616168276,
                720575940622087245,
                720575940630446970,
                720575940639745907,
                720575940625774631,
                720575940604687532,
                720575940628177738,
                720575940617076258,
                720575940632094824,
                720575940633074783,
                720575940623628105,
                720575940618728606,
                720575940618739136,
                720575940629042639,
                720575940639096435,
                720575940631828817,
                720575940630567698,
                720575940625303788,
                720575940633611883,
                720575940636264952,
                720575940628444688,
                720575940613616559,
                720575940622516104,
                720575940620233899,
                720575940625225085,
                720575940627970122,
                720575940632932143,
                720575940627082329,
                720575940650403449,
                720575940607996034,
                720575940621633140,
                720575940631116586,
                720575940625614101,
                720575940627928698,
                720575940640672501,
                720575940626089609,
                720575940610695338,
                720575940634440858,
                720575940639250741,
                720575940623887128,
                720575940627149686,
                720575940605581024,
                720575940630767631,
                720575940604508332,
                720575940622747772,
                720575940625496720,
                720575940640466677,
                720575940621548543,
                720575940624951560,
                720575940617366457,
                720575940631433487,
                720575940647995769,
                720575940620462177,
                720575940629588891,
                720575940615912916,
                720575940625666488,
                720575940618209360,
                720575940612334810,
                720575940637885043,
                720575940619876890,
                720575940639223203,
                720575940630827339,
                720575940639411363,
                720575940621647996,
                720575940640180339,
                720575940617620509,
                720575940612944298,
                720575940629829275,
                720575940638407494,
                720575940608810798,
                720575940629866434,
                720575940630600951,
                720575940630542663,
                720575940610578786,
                720575940624689610,
                720575940615811807,
                720575940632129295,
                720575940639258200,
                720575940623604149,
                720575940627733447,
                720575940618186836,
                720575940639592381,
                720575940631894753,
                720575940606654386,
                720575940628589032,
                720575940639009087,
                720575940620298754,
                720575940629246586,
                720575940632055912,
                720575940617817693,
                720575940620811892,
                720575940628618920,
                720575940611216867,
                720575940608278281,
                720575940632194221,
                720575940629287034,
                720575940631162410,
                720575940610214513,
                720575940626104648,
                720575940631103007,
                720575940626607110,
                720575940611126648,
                720575940625478458,
                720575940631717906,
                720575940629545803,
                720575940621756336,
                720575940614518678,
                720575940626888720,
                720575940619944360,
                720575940630946989,
                720575940650001529,
                720575940625568010,
                720575940616304925,
                720575940620525076,
                720575940641202640,
                720575940631816332,
                720575940618133328,
                720575940615420358,
                720575940626900086,
                720575940616111221,
                720575940630936315,
                720575940625672548,
                720575940630139074,
                720575940610953478,
                720575940637643950,
                720575940631195333,
                720575940605478321,
                720575940630535564,
                720575940636962138,
                720575940633476141,
                720575940632232418,
                720575940622933444,
                720575940616367133,
                720575940635757168,
                720575940630146668,
                720575940632396444,
                720575940624433644,
                720575940626525982,
                720575940622930019,
                720575940625668868,
                720575940624345341,
                720575940618148766,
                720575940614924946,
                720575940631903713,
                720575940621314440,
                720575940630000399,
                720575940603042272,
                720575940629418110,
                720575940630369068,
                720575940620655854,
                720575940624328167,
                720575940622271752,
                720575940612562525,
                720575940619967435,
                720575940633705327,
                720575940631087831,
                720575940630299276,
                720575940628590235,
                720575940616982870,
                720575940621407470,
                720575940645541252,
                720575940646433076,
                720575940614779026,
                720575940620826900,
                720575940611882725,
                720575940621181424,
                720575940626436733,
                720575940630697124,
                720575940630011961,
                720575940607385283,
                720575940631682003,
                720575940609063800,
                720575940629855964,
                720575940627757208,
                720575940630171207,
                720575940632378695,
                720575940637260133,
                720575940613709983,
                720575940621716883,
                720575940621003457,
                720575940630697576,
                720575940644510574,
                720575940609453010,
                720575940624322341,
                720575940622864169,
                720575940637571812,
                720575940627669239,
                720575940634215393,
                720575940604126176,
                720575940625724618,
                720575940611704689,
                720575940605270974,
                720575940621269603,
                720575940619624630,
                720575940643527112,
                720575940628416060,
                720575940639404605,
                720575940621505718,
                720575940611054798,
                720575940613416744,
                720575940606944898,
                720575940622468681,
                720575940650510838,
                720575940615240103,
                720575940655608481,
                720575940635149466,
                720575940625547909,
                720575940627147080,
                720575940605215665,
                720575940615908353,
                720575940619780731,
                720575940645669940,
                720575940617320331,
                720575940605262880,
                720575940617449506,
                720575940619224990,
                720575940626235644,
                720575940625924995,
                720575940613994898,
                720575940626644496,
                720575940621643132,
                720575940626331481,
                720575940627163464,
                720575940618490782,
                720575940640250496,
                720575940638312006,
                720575940630201851,
                720575940639065296,
                720575940614210513,
                720575940624950676,
                720575940622617736,
                720575940630386060,
                720575940628359223,
                720575940628863994,
                720575940634028655,
                720575940628087913,
                720575940618013745,
                720575940614185110,
                720575940636890224,
                720575940626697609,
                720575940612109619,
                720575940626425219,
                720575940632164044,
                720575940629355202,
                720575940634689561,
                720575940620552973,
                720575940631644719,
                720575940640355213,
                720575940631284342,
                720575940632034724,
                720575940614212258,
                720575940639311488,
                720575940616176852,
                720575940625269822,
                720575940619977087,
                720575940626852201,
                720575940615266866,
                720575940628537964,
                720575940610903854,
                720575940634823822,
                720575940643862324,
                720575940611685489,
                720575940623571555,
                720575940643929800,
                720575940618826314,
                720575940630055272,
                720575940630034243,
                720575940629129679,
                720575940634769562,
                720575940604191456,
                720575940622304895,
                720575940636425870,
                720575940620739494,
                720575940614935249,
                720575940610952982,
                720575940628618664,
                720575940621183624,
                720575940627864305,
                720575940620775856,
                720575940628157595,
                720575940627077894,
                720575940635246755,
                720575940623948432,
                720575940625273118,
                720575940614486782,
                720575940619519061,
                720575940630720204,
                720575940603200428,
                720575940630787599,
                720575940619213771,
                720575940648026756,
                720575940638318399,
                720575940615649366,
                720575940629070339,
                720575940621472750,
                720575940613120741,
                720575940631681095,
                720575940632606509,
                720575940625223954,
                720575940617637204,
                720575940637643241,
                720575940625410441,
                720575940636481513,
                720575940610740394,
                720575940617578267,
                720575940631718028,
                720575940620780270,
                720575940610277956,
                720575940630944505,
                720575940614682535,
                720575940630440007,
                720575940622765900,
                720575940635889015,
                720575940619308653,
                720575940608350473,
                720575940612556438,
                720575940611625238,
                720575940632717359,
                720575940627080945,
                720575940626085264,
                720575940613127574,
                720575940628273468,
                720575940632238675,
                720575940624733769,
                720575940617882342,
                720575940613508210,
                720575940630294902,
                720575940630416766,
                720575940633827996,
                720575940606042814,
                720575940630505463,
                720575940625428368,
                720575940616553541,
                720575940623221774,
                720575940631681298,
                720575940616097653,
                720575940609925589,
                720575940622780118,
                720575940626252303,
                720575940625981327,
                720575940610979590,
                720575940634360546,
                720575940643266583,
                720575940631679530,
                720575940627395345,
                720575940622033110,
                720575940624185904,
                720575940623738365,
                720575940607730780,
                720575940626810442,
                720575940621585276,
                720575940630223468,
                720575940637431110,
                720575940640143192,
                720575940610427877,
                720575940636894022,
                720575940626850678,
                720575940629104377,
                720575940627984650,
                720575940624136485,
                720575940609463620,
                720575940629349826,
                720575940636169705,
                720575940633468385,
                720575940613102053,
                720575940631865874,
                720575940611352469,
                720575940619624374,
                720575940610007598,
                720575940620922644,
                720575940629426450,
                720575940635825144,
                720575940623328184,
                720575940627160143,
                720575940613956242,
                720575940606665564,
                720575940628637672,
                720575940620115541,
                720575940614104774,
                720575940629098878,
                720575940626026005,
                720575940612352114,
                720575940619905919,
                720575940615702621,
                720575940644093719,
                720575940603327916,
                720575940646428980,
                720575940646413108,
                720575940621263014,
                720575940616748096,
                720575940627963978,
                720575940614966481,
                720575940626290172,
                720575940627177491,
                720575940621723283,
                720575940627476040,
                720575940632433052,
                720575940624086408,
                720575940637106573,
                720575940626192771,
                720575940649324153,
                720575940621454427,
                720575940625581605,
                720575940623989247,
                720575940627704339,
                720575940637230766,
                720575940624599836,
                720575940629685291,
                720575940637922877,
                720575940610177941,
                720575940621265373,
                720575940632769678,
                720575940614968938,
                720575940626761603,
                720575940614545851,
                720575940617509716,
                720575940622718344,
                720575940632213933,
                720575940621683973,
                720575940622263815,
                720575940606712777,
                720575940635542895,
                720575940622622502,
                720575940626684689,
                720575940630379884,
                720575940655410849,
                720575940623566472,
                720575940632698399,
                720575940610674090,
                720575940612523669,
                720575940611361378,
                720575940644391112,
                720575940620960020,
                720575940629703724,
                720575940641108699,
                720575940617090745,
                720575940627723416,
                720575940637471054,
                720575940628748816,
                720575940615279419,
                720575940608927534,
                720575940637228206,
                720575940611362965,
                720575940620210014,
                720575940628544828,
                720575940620159960,
                720575940628423592,
                720575940603935334,
                720575940623312408,
                720575940616085917,
                720575940631059451,
                720575940622539912,
            ]
            mi1_right_in_630 = set(
                [r for r in mi1_right if r in self.neuron_db.neuron_data]
            )
            mi1_left_in_630 = set(
                [r for r in mi1_left if r in self.neuron_db.neuron_data]
            )
            print(
                f"+++ {len(mi1_right)=} {len(set(mi1_right))=} {len(mi1_right_in_630)=}"
            )
            print(f"+++ {len(mi1_left)=} {len(set(mi1_left))=} {len(mi1_left_in_630)=}")

            mi1_right_search = self.neuron_db.search(
                "mi1 && side == right && super_class == optic", word_match=True
            )
            mi1_left_search = self.neuron_db.search(
                "mi1 && side == left && super_class == optic", word_match=True
            )
            self.assertEqual(
                len(mi1_right_in_630),
                len(mi1_right_in_630.intersection(mi1_right_search)),
            )
            self.assertEqual(
                len(mi1_left_in_630), len(mi1_left_in_630.intersection(mi1_left_search))
            )

            ds_positive = set(mi1_right_search + mi1_left_search)
        else:
            ds_positive = set(
                self.neuron_db.search(
                    ol_type + " && side {in} right, left && super_class == optic",
                    word_match=True,
                )
            )
        ds_negative = [
            r
            for r in self.neuron_db.search(
                "super_class == optic && side {in} right, left"
            )
            if r not in ds_positive
        ]
        self.assertEqual(0, len(ds_positive.intersection(ds_negative)))
        ds_positive = list(ds_positive)

        random.seed(0)
        random.shuffle(ds_positive)
        random.shuffle(ds_negative)

        print(f"{len(ds_positive)=} {len(ds_negative)=}")

        def project_neuropil(rgn):
            if rgn.endswith("_L") or rgn.endswith("_R"):
                return rgn[:-2]
            return rgn

        regions = sorted(set([project_neuropil(rgn) for rgn in REGIONS.keys()]))
        print(f"regions: {len(regions)}")

        all_rids_set = set(ds_positive + ds_negative)
        in_region_index = {rgn: i for i, rgn in enumerate(regions)}
        out_region_index = {rgn: i + len(regions) for i, rgn in enumerate(regions)}
        neuropil_synapse_projections = {
            r: [0] * (2 * len(regions)) for r in all_rids_set
        }
        neuropil_partner_projections = {
            r: [0] * (2 * len(regions)) for r in all_rids_set
        }
        for r in self.neuron_db.connection_rows:
            if r[0] in all_rids_set:
                neuropil_synapse_projections[r[0]][
                    out_region_index[project_neuropil(r[2])]
                ] += r[3]
                neuropil_partner_projections[r[0]][
                    out_region_index[project_neuropil(r[2])]
                ] += 1
            if r[1] in all_rids_set:
                neuropil_synapse_projections[r[1]][
                    in_region_index[project_neuropil(r[2])]
                ] += r[3]
                neuropil_partner_projections[r[1]][
                    in_region_index[project_neuropil(r[2])]
                ] += 1

        def feature_vector(rid):
            nd = self.neuron_db.neuron_data[rid]
            return [
                len(nd["input_neuropils"]),
                len(nd["output_neuropils"]),
            ] + neuropil_partner_projections[
                rid
            ]  # + neuropil_synapse_projections[rid]

        NP = round((10 * len(ds_positive)) / 100)
        NN = round((5 * len(ds_negative)) / 100)
        print(f"Positive samples: {NP} / {len(ds_positive)}")
        print(f"Negative samples: {NN} / {len(ds_negative)}")
        X = list()

        for rid in ds_positive[:NP]:
            X.append(feature_vector(rid))
        for rid in ds_negative[:NN]:
            X.append(feature_vector(rid))
        Y = [1] * NP + [0] * NN

        clf = svm.SVC()
        clf.fit(X, Y)

        T = list()
        for rid in ds_positive[NP:]:
            T.append(feature_vector(rid))
        for rid in ds_negative[NN:]:
            T.append(feature_vector(rid))

        predictions = clf.predict(T)
        print(f"predictions: {len(predictions)}")

        tp, tn, fp, fn = [], [], [], []
        for i, p in enumerate(predictions):
            self.assertTrue(p in [0, 1])
            if i < len(ds_positive) - NP:
                if p == 0:
                    fn.append(ds_positive[NP + i])
                else:
                    tp.append(ds_positive[NP + i])
            else:
                idx = NN + i - (len(ds_positive) - NP)
                if p == 1:
                    fp.append(ds_negative[idx])
                else:
                    tn.append(ds_negative[idx])

        log_dev_url_for_root_ids("False negatives", fn[:50], prod=True)
        log_dev_url_for_root_ids("False positives", fp[:50], prod=True)

        print(
            f"{len(tn)=} ({percentage(len(tn), len(ds_negative))}) {len(tp)=} ({percentage(len(tp), len(ds_positive))})"
        )
        print(
            f"{len(fn)=} ({percentage(len(fn), len(ds_positive))}) {len(fp)=} ({percentage(len(fp), len(ds_negative))})"
        )
        precision = len(tp) / max(1, len(tp) + len(fp))
        recall = len(tp) / max(1, len(tp) + len(fn))
        f1 = 2 * precision * recall / max(1, precision + recall)
        print(f"{precision=} {recall=} {f1=}")

    def test_ol_iso(self):
        mi1_left = set(self.neuron_db.search("marker == mi1 && side == left"))
        self.assertEqual(790, len(mi1_left))
        mi1_right = set(self.neuron_db.search("marker == mi1 && side == right"))
        self.assertEqual(768, len(mi1_right))

        ins, outs = self.neuron_db.input_output_partner_sets()

        l_ins_distro, r_ins_distro, l_outs_distro, r_outs_distro = (
            defaultdict(int),
            defaultdict(int),
            defaultdict(int),
            defaultdict(int),
        )
        all_ins = []
        all_outs = []

        def distro_update(rid_list, dct):
            for rid in rid_list:
                nd = self.neuron_db.neuron_data[rid]
                if nd["marker"] and ":" not in nd["marker"][0]:
                    dct[nd["marker"][0]] += 1
                for ct in nd["cell_type"]:
                    dct[ct] += 1

        for n in mi1_left:
            all_ins.extend(ins[n])
            all_outs.extend(outs[n])
            distro_update(ins[n], l_ins_distro)
            distro_update(outs[n], l_outs_distro)
        for n in mi1_right:
            all_ins.extend(ins[n])
            all_outs.extend(outs[n])
            distro_update(ins[n], r_ins_distro)
            distro_update(outs[n], r_outs_distro)

        def print_distro(dst, caption):
            print(caption)
            for k, v in sorted(dst.items(), key=lambda x: -x[1]):
                print(f"Number of cells with {k}: {v}")

        print_distro(l_ins_distro, "left inputs")
        print_distro(l_outs_distro, "left outputs")
        print_distro(r_ins_distro, "right inputs")
        print_distro(r_outs_distro, "right outputs")

        print(f"All ins list: {len(all_ins)}, set: {len(set(all_ins))}")
        print(f"All outs list: {len(all_outs)}, set: {len(set(all_outs))}")
        print(f"Ins/Outs intersection: {len(set(all_ins).intersection(all_outs))}")
