from unittest import TestCase

from codex.utils.graph_algos import pathways, reachable_node_counts
from tests import get_testing_neuron_db


class TestGraphAlgos(TestCase):
    @classmethod
    def setUpClass(cls):
        cls.neuron_db = get_testing_neuron_db()

    def test_reachable_node_counts(self):
        num_cells = len(self.neuron_db.neuron_data)
        isets = self.neuron_db.input_sets()
        for n in sorted(self.neuron_db.neuron_data.keys())[1000:1001]:
            self.assertEqual(
                {
                    "1 hop": "12 (0%)",
                    "2 hops": "5,261 (3%)",
                    "3 hops": "23,733 (17%)",
                    "4 hops": "77,092 (55%)",
                    "5 hops": "118,010 (84%)",
                    "6 hops": "127,454 (91%)",
                    "7 hops": "127,815 (91%)",
                    "8 hops": "127,837 (91%)",
                },
                reachable_node_counts({n}, isets, num_cells),
            )

    def test_pathways(self):
        s = t = 0
        isets = self.neuron_db.input_sets()
        osets = self.neuron_db.output_sets()
        all_rids = sorted(self.neuron_db.neuron_data.keys())

        self.assertEqual(None, pathways(s, t, isets, osets))

        s = all_rids[100]
        t = all_rids[101]

        self.assertEqual(None, pathways(s, s, isets, osets))
        self.assertEqual(
            {
                720575940602928608: 0,
                720575940602943968: 4,
                720575940603526005: 2,
                720575940604636789: 2,
                720575940605413129: 2,
                720575940607902682: 2,
                720575940608187778: 3,
                720575940608288523: 2,
                720575940609744733: 2,
                720575940612276578: 3,
                720575940613416744: 2,
                720575940617572609: 2,
                720575940618009318: 2,
                720575940618490782: 2,
                720575940618755638: 2,
                720575940619209408: 2,
                720575940620034932: 2,
                720575940620851695: 3,
                720575940624193255: 2,
                720575940625242882: 2,
                720575940626783507: 1,
                720575940626872932: 3,
                720575940626979621: 1,
                720575940627201929: 2,
                720575940627598852: 2,
                720575940628259594: 2,
                720575940629385594: 2,
                720575940629548800: 1,
                720575940632375379: 2,
                720575940632621988: 2,
                720575940634594411: 1,
                720575940634612194: 2,
                720575940634753983: 2,
                720575940635232180: 2,
                720575940635542452: 2,
                720575940644255904: 3,
                720575940645745262: 3,
            },
            dict(pathways(s, t, isets, osets)),
        )

        s = all_rids[200]
        t = all_rids[201]
        self.assertEqual(
            {
                720575940603409632: 0,
                720575940603430112: 6,
                720575940606776009: 4,
                720575940611160930: 3,
                720575940620321670: 4,
                720575940623387786: 3,
                720575940625518736: 2,
                720575940628050950: 2,
                720575940630939855: 4,
                720575940638128474: 5,
                720575940643576224: 1,
            },
            dict(pathways(s, t, isets, osets)),
        )

        s = all_rids[400]
        t = all_rids[401]
        self.assertEqual(
            {
                720575940603094700: 4,
                720575940603893280: 0,
                720575940603895584: 5,
                720575940605824945: 3,
                720575940606042144: 1,
                720575940607621059: 4,
                720575940608180949: 3,
                720575940610263665: 4,
                720575940610602410: 4,
                720575940610974577: 3,
                720575940616695947: 3,
                720575940617314939: 4,
                720575940618804603: 3,
                720575940619103142: 4,
                720575940619310641: 3,
                720575940622252493: 4,
                720575940622991252: 4,
                720575940623496035: 2,
                720575940624822680: 4,
                720575940625486910: 3,
                720575940626291998: 4,
                720575940627761162: 3,
                720575940628070460: 4,
                720575940628093895: 4,
                720575940628319400: 3,
                720575940630013143: 4,
                720575940630348140: 4,
                720575940631043139: 2,
                720575940631264849: 4,
                720575940632742099: 3,
                720575940633171916: 2,
                720575940636455280: 3,
                720575940639209461: 4,
                720575940641679245: 3,
                720575940650254582: 4,
            },
            dict(pathways(s, t, isets, osets)),
        )
