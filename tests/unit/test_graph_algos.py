from unittest import TestCase

from src.data.neuron_data_factory import NeuronDataFactory
from src.utils.graph_algos import pathways, reachable_node_counts
from tests import TEST_NEURON_DATA_FACTORY


class TestGraphAlgos(TestCase):
    @classmethod
    def setUpClass(cls):
        cls.neuron_db = TEST_NEURON_DATA_FACTORY.get()

    def test_reachable_node_counts(self):
        num_cells = len(self.neuron_db.neuron_data)
        isets = self.neuron_db.input_sets()
        for n in sorted(self.neuron_db.neuron_data.keys())[1000:1001]:
            self.assertEqual(
                {
                    "1 hop": "78 (0%)",
                    "2 hops": "1,193 (1%)",
                    "3 hops": "12,931 (12%)",
                    "4 hops": "54,358 (53%)",
                    "5 hops": "92,906 (91%)",
                    "6 hops": "98,250 (96%)",
                    "7 hops": "98,408 (96%)",
                    "8 hops": "98,420 (96%)",
                },
                reachable_node_counts({n}, isets, num_cells),
            )

    def test_pathways(self):
        s = t = 0
        isets = self.neuron_db.input_sets()
        osets = self.neuron_db.output_sets()
        all_rids = sorted(self.neuron_db.neuron_data.keys())

        self.assertEqual(None, pathways(s, t, isets, osets))

        s = all_rids[100]
        t = all_rids[101]

        self.assertEqual(None, pathways(s, s, isets, osets))
        self.assertEqual(
            {
                720575940602914988: 0,
                720575940602917088: 5,
                720575940607761244: 1,
                720575940607982345: 3,
                720575940608744405: 3,
                720575940609352899: 2,
                720575940611638258: 3,
                720575940613303471: 3,
                720575940614908383: 3,
                720575940615370635: 2,
                720575940616063291: 1,
                720575940616807897: 3,
                720575940617423846: 4,
                720575940617597233: 1,
                720575940617940308: 1,
                720575940618464822: 2,
                720575940618807454: 2,
                720575940618849227: 3,
                720575940619268193: 1,
                720575940619415679: 1,
                720575940619610294: 3,
                720575940619688688: 2,
                720575940620123613: 2,
                720575940620356545: 2,
                720575940620424472: 2,
                720575940620943201: 2,
                720575940620943969: 2,
                720575940621057702: 3,
                720575940621264809: 2,
                720575940622045133: 1,
                720575940622123981: 1,
                720575940624472334: 2,
                720575940625042983: 3,
                720575940625174334: 1,
                720575940625840970: 1,
                720575940626112062: 3,
                720575940626315207: 4,
                720575940626363261: 2,
                720575940626793831: 2,
                720575940627929820: 2,
                720575940628239183: 3,
                720575940628837650: 2,
                720575940629358391: 3,
                720575940629428522: 2,
                720575940630881337: 2,
                720575940631938371: 3,
                720575940632385943: 1,
                720575940632530387: 2,
                720575940632764883: 2,
                720575940633131512: 2,
                720575940633522658: 1,
                720575940635028591: 2,
                720575940637175349: 2,
                720575940637755507: 1,
                720575940638077811: 2,
                720575940640176848: 2,
                720575940642453448: 1,
                720575940643919908: 3,
                720575940644426094: 1,
                720575940651804918: 2,
                720575940654129313: 3,
            },
            pathways(s, t, isets, osets),
        )

        s = all_rids[200]
        t = all_rids[201]
        self.assertEqual(
            {
                720575940603409632: 0,
                720575940603430112: 7,
                720575940606776009: 5,
                720575940608451420: 3,
                720575940610177203: 2,
                720575940610620770: 4,
                720575940611550643: 4,
                720575940612337331: 3,
                720575940612364530: 3,
                720575940612922226: 4,
                720575940614123570: 2,
                720575940614595582: 3,
                720575940615655611: 3,
                720575940615782841: 2,
                720575940615916957: 2,
                720575940616580379: 2,
                720575940616812217: 4,
                720575940617498688: 3,
                720575940617952034: 4,
                720575940618268229: 4,
                720575940618710918: 2,
                720575940619401563: 2,
                720575940619797185: 4,
                720575940619876884: 3,
                720575940619895125: 5,
                720575940620321670: 5,
                720575940620732329: 3,
                720575940621202096: 3,
                720575940621385844: 5,
                720575940621449221: 4,
                720575940621518768: 5,
                720575940621667711: 4,
                720575940622117914: 5,
                720575940623536324: 4,
                720575940624201033: 5,
                720575940624982286: 4,
                720575940625203277: 3,
                720575940625259056: 2,
                720575940625518736: 2,
                720575940626067729: 3,
                720575940626112062: 3,
                720575940626783065: 4,
                720575940627092367: 4,
                720575940627296652: 2,
                720575940627361157: 3,
                720575940627383685: 4,
                720575940628050950: 2,
                720575940628081905: 5,
                720575940628819447: 2,
                720575940628858306: 5,
                720575940628977401: 4,
                720575940628990031: 5,
                720575940629845303: 4,
                720575940629894716: 4,
                720575940630346860: 4,
                720575940630939855: 5,
                720575940631117842: 4,
                720575940631991266: 4,
                720575940632200749: 4,
                720575940632659404: 3,
                720575940635990640: 3,
                720575940638128474: 6,
                720575940638343238: 4,
                720575940639188413: 3,
                720575940639830179: 4,
                720575940640096976: 4,
                720575940643576224: 1,
                720575940645258606: 4,
                720575940645538158: 3,
                720575940646796932: 3,
            },
            pathways(s, t, isets, osets),
        )

        s = all_rids[300]
        t = all_rids[301]
        self.assertEqual(
            {
                720575940603048108: 2,
                720575940603676774: 0,
                720575940603676844: 5,
                720575940610069550: 4,
                720575940612870952: 2,
                720575940615877410: 1,
                720575940616661465: 3,
                720575940616819345: 2,
                720575940618295376: 3,
                720575940618924373: 3,
                720575940619237985: 1,
                720575940620496990: 4,
                720575940620952865: 2,
                720575940621975081: 2,
                720575940622069347: 2,
                720575940622651656: 4,
                720575940622873095: 4,
                720575940623465963: 3,
                720575940623861479: 4,
                720575940624172873: 2,
                720575940624381966: 3,
                720575940625308162: 2,
                720575940625520165: 2,
                720575940625964712: 3,
                720575940626316606: 2,
                720575940626343305: 3,
                720575940626612254: 4,
                720575940626666345: 3,
                720575940628014441: 4,
                720575940628057862: 3,
                720575940628386942: 2,
                720575940628793982: 3,
                720575940629483735: 2,
                720575940630671953: 4,
                720575940630683410: 3,
                720575940630942506: 3,
                720575940631355044: 2,
                720575940631785441: 3,
                720575940632097965: 3,
                720575940632720279: 3,
                720575940632862177: 2,
                720575940639404416: 2,
                720575940639710883: 2,
                720575940640008400: 4,
                720575940642476448: 4,
                720575940642860192: 2,
                720575940643153824: 2,
                720575940644492055: 2,
                720575940645255476: 4,
                720575940648742777: 2,
                720575940652083190: 4,
            },
            pathways(s, t, isets, osets),
        )
